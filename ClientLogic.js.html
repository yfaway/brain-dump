<script>
$(function() {
  google.script.run.withSuccessHandler(renderTagList)
      .getTagsSortedByPopularity();
});

String.prototype.format = function (){
    var args = arguments;
    return this.replace(/\{\{|\}\}|\{(\d+)\}/g, function (curlyBrack, index) {
        return ((curlyBrack == "{{") ? "{" : ((curlyBrack == "}}") ? "}" : args[index]));
    });
};

/**
 * Displays each tag as an html link. Upon click, request the entries matching
 * the tags and display it in the entry area.
 */
function renderTagList(tags) {
  tags.forEach(function(tag) {
    renderASingleTag($("#tags-list"), tag.name, tag.count);
  });
}

// The code in this function runs when the page is loaded.
function onAddEntry() {
  var tagsArray = $("#input-tags").val().split(' ');
  google.script.run.withSuccessHandler(refreshTopTen)
    .addEntry($("#input-content").val(), tagsArray);
  return false;
};

function refreshTopTen(things) {
  google.script.run
    .withSuccessHandler(renderEntries)
    .findEntriesByTag('All', 0, 10);
}

/**
 * Clears the entry div container and renders the provided entries.
 * @param entries
 */
function renderEntries(result) {
  var entries = result.entries;

  // clear all the entry tag events first
  var entryTagIdPrefix = 'entry-tag-';
  //$("[id^=" + entryTagIdPrefix + "]").off('click');

  $("#entry-list").html('');

  // Prev and Next links

  $("#prev").off('click');
  $("#next").off('click');
  $("#entry-list").append('<div>');

  if ( result.offset > 0 ) {
    $("#entry-list").append("[<a href='' id='prev'>Prev</a>] ");
  }
  else {
    $("#entry-list").append("[Prev] ");
  }

  if ( result.hasMore ) {
    $("#entry-list").append("[<a href='' id='next'>Next</a>] ");
  }
  else {
    $("#entry-list").append("[Next] ");
  }

  $("#entry-list").append('</div>');

  $("#prev").click(function() {
      google.script.run
        .withSuccessHandler(renderEntries)
        .findEntriesByTag(result.searchValue, 
            result.offset - result.count, 
            result.count);
      return false;
  });

  $("#next").click(function() {
      google.script.run
        .withSuccessHandler(renderEntries)
        .findEntriesByTag(result.searchValue, 
            result.offset + result.count, 
            result.count);
      return false;
  });

  entries.forEach(function(entry) {
    $("#entry-list").append('<div>');
    var html = "<p id='entry-content'>{0}</p>".format(entry.content);
    $("#entry-list").append(html);

    $("#entry-list").append('Tags: ');
    entry.tags.forEach(function(name) {
      renderASingleTag($("#entry-list"), name, null, entryTagIdPrefix);
    });

    html = "<br />{0}<hr />".format(
        new Date(entry.creationTime).toLocaleString());
    $("#entry-list").append(html);
    $("#entry-list").append('<hr/>');
    $("#entry-list").append('</div>');
  });

  $("#" + id).click(function() {
      google.script.run
        .withSuccessHandler(renderEntries)
        .findEntriesByTag(tagName, 0, 10);
      return false;
  });

}

function renderASingleTag(container, tagName, tagCount, idPrefix) {
  if ( 'undefined' == typeof idPrefix ) {
    idPrefix = 'tag-';
  }
  var id = idPrefix + tagName;

  var html;
  if (null != tagCount) {
    html = "<a href='' id='{0}'>{1} ({2})</a> ".format(id, tagName, tagCount); 
  }
  else {
    html = "<a href='' id='{0}'>{1}</a> ".format(id, tagName); 
  }
  container.append(html);

  $("#" + id).click(function() {
      google.script.run
        .withSuccessHandler(renderEntries)
        .findEntriesByTag(tagName, 0, 10);
      return false;
  });
}
</script>  
