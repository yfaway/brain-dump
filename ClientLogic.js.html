<script>
$(function() {
  google.script.run.withSuccessHandler(renderTagList)
      .getTagsSortedByPopularity();
});

String.prototype.format = function (){
    var args = arguments;
    return this.replace(/\{\{|\}\}|\{(\d+)\}/g, function (curlyBrack, index) {
        return ((curlyBrack == "{{") ? "{" : ((curlyBrack == "}}") ? "}" : args[index]));
    });
};

/**
 * Displays each tag as an html link. Upon click, request the entries matching
 * the tags and display it in the entry area.
 */
function renderTagList(tags) {
  tags.forEach(function(tag) {
    renderASingleTag($("#tags-list"), tag.name, tag.count);
  });
}

// The code in this function runs when the page is loaded.
function onAddEntry() {
  var tagsArray = $("#input-tags").val().split(' ');
  google.script.run.withSuccessHandler(refreshTopTen)
    .addEntry($("#input-content").val(), tagsArray);
  return false;
};

function refreshTopTen(things) {
  google.script.run
    .withSuccessHandler(renderEntries)
    .findEntriesByTag('All', 0, 10);
}

/**
 * Clears the entry div container and renders the provided entries.
 * @param entries
 */
function renderEntries(entries) {
  $("#entry-list").html('');

  entries.forEach(function(entry) {
    $("#entry-list").append('<div>');
    var html = "<p id='entry-content'>{0}</p>".format(entry.content);
    $("#entry-list").append(html);

    $("#entry-list").append('Tags: ');
    entry.tags.forEach(function(name) {
      renderASingleTag($("#entry-list"), name, null, 'entry-tag-');
    });

    html = "<br />{0}<hr />".format(new Date(entry.creationTime).toLocaleString());
    $("#entry-list").append(html);
    $("#entry-list").append('<hr/>');
    $("#entry-list").append('</div>');
  });
}

function renderASingleTag(container, tagName, tagCount, idPrefix) {
  if ( 'undefined' == typeof idPrefix ) {
    idPrefix = 'tag-';
  }
  var id = idPrefix + tagName;

  var html;
  if (null != tagCount) {
    html = "<a href='' id='{0}'>{1} ({2})</a> ".format(id, tagName, tagCount); 
  }
  else {
    html = "<a href='' id='{0}'>{1}</a> ".format(id, tagName); 
  }
  container.append(html);

  $("#" + id).click(function() {
      google.script.run
        .withSuccessHandler(renderEntries)
        .findEntriesByTag(tagName);
      return false;
  });
}
</script>  
